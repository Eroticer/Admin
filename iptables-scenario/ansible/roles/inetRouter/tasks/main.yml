---
- name: Configure knocking port iptables rules
  block:
    - name: Flush existing iptables rules
      iptables:
        flush: yes

    - name: Set default policies
      iptables:
        chain: "{{ item.chain }}"
        policy: "{{ item.policy }}"
      with_items:
        - { chain: 'INPUT', policy: 'DROP' }
        - { chain: 'FORWARD', policy: 'DROP' }
        - { chain: 'OUTPUT', policy: 'ACCEPT' }

    - name: Allow loopback
      iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT

    - name: Allow established connections
      iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: Allow ICMP
      iptables:
        chain: INPUT
        protocol: icmp
        jump: ACCEPT

    - name: Create KNOCKING chain
      iptables:
        chain: KNOCKING
        state: present

    - name: Add knocking sequence rules
      iptables:
        chain: KNOCKING
        source: "192.168.10.0/24"
        protocol: tcp
        destination_port: "{{ item.port }}"
        ctstate: NEW
        recent:
          name: "{{ item.name }}"
          set: yes
        jump: DROP
      with_items:
        - { port: '1111', name: 'KNOCK1' }
        - { port: '2222', name: 'KNOCK2' }
        - { port: '3333', name: 'KNOCK3' }

    - name: Final knocking rule - open SSH
      iptables:
        chain: KNOCKING
        source: "192.168.10.0/24"
        protocol: tcp
        destination_port: '22'
        ctstate: NEW
        recent:
          name: KNOCK3
          remove: yes
        jump: ACCEPT
        comment: "Knocking sequence completed - SSH access granted"

    - name: Send packets to KNOCKING chain
      iptables:
        chain: INPUT
        source: "192.168.10.0/24"
        protocol: tcp
        jump: KNOCKING

    - name: Allow SSH from internal network (after knocking)
      iptables:
        chain: INPUT
        source: "192.168.10.0/24"
        protocol: tcp
        destination_port: '22'
        jump: ACCEPT
        comment: "SSH access after knocking"

    - name: Allow forwarding between networks
      iptables:
        chain: FORWARD
        source: "192.168.10.0/24"
        destination: "192.168.20.0/24"
        jump: ACCEPT

    - name: Allow return traffic
      iptables:
        chain: FORWARD
        source: "192.168.20.0/24"
        destination: "192.168.10.0/24"
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: Configure NAT for internet access
      iptables:
        table: nat
        chain: POSTROUTING
        out_interface: eth0
        jump: MASQUERADE

    - name: Save iptables rules
      command: iptables-save > /etc/sysconfig/iptables
      args:
        creates: /etc/sysconfig/iptables

  rescue:
    - name: Reset iptables on error
      command: iptables -F
      ignore_errors: yes

- name: Configure routing
  template:
    src: routes.j2
    dest: /etc/sysconfig/network-scripts/route-eth1
    owner: root
    group: root
    mode: '0644'