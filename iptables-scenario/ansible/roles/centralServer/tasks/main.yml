---
- name: Install nginx
  dnf:
    name: nginx
    state: present

- name: Configure nginx welcome page
  copy:
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>Welcome to Central Server</title>
      </head>
      <body>
          <h1>Welcome to Central Server!</h1>
          <p>This server is accessible via port knocking and port forwarding.</p>
          <p>Server IP: 192.168.20.10</p>
      </body>
      </html>
    dest: /usr/share/nginx/html/index.html
    owner: root
    group: root
    mode: '0644'

- name: Start and enable nginx
  systemd:
    name: nginx
    state: started
    enabled: yes

- name: Configure iptables for web server
  block:
    - name: Flush existing iptables rules
      iptables:
        flush: yes

    - name: Set default policies
      iptables:
        chain: "{{ item.chain }}"
        policy: "{{ item.policy }}"
      with_items:
        - { chain: 'INPUT', policy: 'DROP' }
        - { chain: 'FORWARD', policy: 'DROP' }
        - { chain: 'OUTPUT', policy: 'ACCEPT' }

    - name: Allow loopback
      iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT

    - name: Allow established connections
      iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: Allow ICMP
      iptables:
        chain: INPUT
        protocol: icmp
        jump: ACCEPT

    - name: Allow SSH from internal network
      iptables:
        chain: INPUT
        source: "192.168.20.0/24"
        protocol: tcp
        destination_port: '22'
        jump: ACCEPT

    - name: Allow HTTP from internal network
      iptables:
        chain: INPUT
        source: "192.168.20.0/24"
        protocol: tcp
        destination_port: '80'
        jump: ACCEPT

    - name: Save iptables rules
      command: iptables-save > /etc/sysconfig/iptables
      args:
        creates: /etc/sysconfig/iptables

- name: Configure default gateway
  template:
    src: routes.j2
    dest: /etc/sysconfig/network-scripts/route-eth1
    owner: root
    group: root
    mode: '0644'