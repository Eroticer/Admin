---
- name: Install knock client
  dnf:
    name: knock
    state: present

- name: Copy knock script
  copy:
    src: ../../scripts/knock.sh
    dest: /usr/local/bin/knock-ssh
    owner: root
    group: root
    mode: '0755'

- name: Configure iptables for routing
  block:
    - name: Flush existing iptables rules
      iptables:
        flush: yes

    - name: Set default policies
      iptables:
        chain: "{{ item.chain }}"
        policy: "{{ item.policy }}"
      with_items:
        - { chain: 'INPUT', policy: 'DROP' }
        - { chain: 'FORWARD', policy: 'ACCEPT' }
        - { chain: 'OUTPUT', policy: 'ACCEPT' }

    - name: Allow loopback
      iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT

    - name: Allow established connections
      iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: Allow ICMP
      iptables:
        chain: INPUT
        protocol: icmp
        jump: ACCEPT

    - name: Allow SSH from internal networks
      iptables:
        chain: INPUT
        source: "192.168.10.0/24"
        protocol: tcp
        destination_port: '22'
        jump: ACCEPT

    - name: Save iptables rules
      command: iptables-save > /etc/sysconfig/iptables
      args:
        creates: /etc/sysconfig/iptables

- name: Configure routing
  template:
    src: routes.j2
    dest: /etc/sysconfig/network-scripts/route-eth1
    owner: root
    group: root
    mode: '0644'